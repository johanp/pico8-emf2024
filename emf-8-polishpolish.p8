pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- emf game
function _init()
 bunny = {
	 x = 63,
	 y = 68,
	 a = rnd()
 }
 
 pickups = {}
 trail = { bunny }
 
 power = 100
 converted_energy = 0
 
 ⧗=0
 
 init_title()
end

function _update()
 ⧗ += 1
 
 if title then
  update_title()
  return
 end
 
 -- decrease power
 if ⧗%10 == 0 then
  power = max(0, power-1)
 end
 
 -- spawn pickups
 if ⧗%10 == 0 then
  spawn_pickup()
 end
 
 
 -- convert energy to power
 -- is on platform?
 bunny.converting = false
 if dist(bunny.x, bunny.y,64,67)<4 then
  if #trail > 1 then
   deli(trail,#trail)
   bunny.converting = true
   converted_energy += 5
   local c = converted_energy/20
   power = min(100, power+c*c)
   sfx(2)
   if ⧗%4==0 then
    bunny.a = rnd()
   end
  else
   converted_energy = 0
  end
 end
 
 
 -- player input
 if not bunny.converting then
	 -- save last position
	 local lx,ly = bunny.x, bunny.y
	 if btn(⬅️) then
	  bunny.x -= 1
	  bunny.mirror = true
	 end
	 if btn(➡️) then
	  bunny.x += 1
	  bunny.mirror = false
	 end
	 if is_solid(bunny.x, bunny.y) then
	  bunny.x, bunny.y = lx, ly
	 end
	
	 local lx,ly = bunny.x, bunny.y
	 if btn(⬆️) then
	  bunny.y -= 1
	 end
	 if btn(⬇️) then
	  bunny.y += 1
	 end
	 if is_solid(bunny.x, bunny.y) then
	  bunny.x, bunny.y = lx, ly
	 end
	 
	end
 
 -- collide with pickups
 for p in all(pickups) do
  if dist(p.x,p.y,bunny.x,bunny.y) < 6 then
   -- remove pickup
   del(pickups, p)
   -- get energy
   add(trail,p,2)
   if p.id == 32 then
    for i=1,8 do
	    add(trail, {
				  x = p.x+16*cos(i/8),
				  y = p.y+16*sin(i/8),
				  ⧗=rnd(30)\1,
				  id = 16
			  },2)
			 end
    sfx(1)
   else
    sfx(0)
			end
  end
 end
 
 
 -- update pickups
 for p in all(pickups) do
  p.⧗ += 1
 end
 
 -- update trail
 for i=#trail,2,-1 do
  local p1 = trail[i]
  local p2 = trail[i-1]
  p1.x += (p2.x-p1.x) * 0.2
  p1.y += (p2.y-p1.y) * 0.2
  p1.⧗ += 1
 end
 
 
end

function _draw()
 if title then
  draw_title()
  return
 end


 cls(3)
 	
 map()
 
 for p in all(pickups) do
  spr(p.id+p.⧗\3%4, p.x-3, p.y-7) 
 end
 
 
 for i=2,#trail do
  local p = trail[i]
  spr(16+p.⧗\3%4, p.x-3, p.y-7) 
 end
 	
 -- draw shadow
 line(bunny.x-2, bunny.y,
      bunny.x+2, bunny.y, 5)
 -- draw bunny
 local x = bunny.x-3
 local y = bunny.y-7
 local frame = 0
 if bunny.converting then
  frame = 4 + ⧗\2%2
  y -= 2-1.5*sin(t()*1.5)
  local r = 1+rnd(4) + converted_energy/4
  circfill(x+4,y+3,r,9)
  circ(x+4,y+3,r,10)
  circ(x+4,y+3,r+rnd(3)+1,7)
  for a=0,0.9,0.25 do
   draw_lightning(x+4,y+3,bunny.a+a,r+10)
  end
 else
  y -= abs(3.5*sin(t()*1.5))
 end
 spr(frame, x, y, 1, 1, bunny.mirror)

 -- ui
 print("power "..flr(power),1,1,1)
end

-->8
-- helpers
function is_solid(x,y)
 local tx = x\8
 local ty = y\8
 local tile = mget(tx, ty)
 local solid = fget(tile,0)
 
 return solid
end

function dist(x1,y1,x2,y2)
 local dx = x1-x2
 local dy = y1-y2
 return sqrt(dx*dx + dy*dy)
end

function sort(a,p)
 for i=1,#a do
  local j = i
  while j > 1 and a[j-1][p] > a[j][p] do
   a[j],a[j-1] = a[j-1],a[j]
   j = j - 1
  end
 end
end

function draw_lightning(_x,_y,a,len)
 local l = 1
 local x1,y1 = _x,_y 
 while l<=len do
  local x2 = _x+l * cos(a)
  local y2 = _y+l * sin(a)
  line(x1,y1, x2,y2, 7)
  line(x1+1,y1-1, x2-1,y2+1, 10)
  x1,y1 = x2,y2
  a+=rnd(0.1)-0.05
  l += 4+rnd(8)
 end
end
-->8
-- pickups
function spawn_pickup()
 -- find spot
 local x,y
 while not x or is_solid(x,y) do
  x = flr(rnd(16)) * 8 + 3+rnd(2)
  y = flr(rnd(16)) * 8 + 3+rnd(2)
 end
 
 -- create pickup
 local pickup = {
  x = x,
  y = y,
  ⧗=rnd(30)\1,
  id = rnd()<0.1 and 32 or 16
 }
 
 -- add to game
 add(pickups, pickup)
end
-->8
function init_title()
 title = true
end

function update_title()
 if btnp(❎) then
  title = false
 end	
end

function draw_title()
	cls(3)
	print("solar bunny hero", 32,32,10)

 print("  THE emf cAMP IS LOSING POWER!\n       COLLECT SOLAR POWER\n    AND DELIVER TO THE CENTER", 0, 64, 9)

 print("❎ to start", 44, 96, 1)
end
__gfx__
00770770000000000000000000000000007707700077077000000000000000000000000000000000000000000000000000000000000000000000000000000000
00770770000000000000000000000000007707700077077000000000000000000000000000000000000000000000000000000000000000000000000000000000
00770770000000000000000000000000007707700077077000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777770000000000000000000000000007777700077777000000000000000000000000000000000000000000000000000000000000000000000000000000000
00717eee000000000000000000000000001eee10071eee1700000000000000000000000000000000000000000000000000000000000000000000000000000000
00777eee000000000000000000000000077eee77007eee7000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777700000000000000000000000000007777700077777000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000007000700700000700000000000000000000000000000000000000000000000000000000000000000000000000000000
00000900000000000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000a0000000a00000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007a0000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00a77a00000aa70000000000000aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00a77a0000a77700000aa00000a77a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000aa00000a77a0000a77a0000a77a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000aa00000a77a00000aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000aa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00aaaa0000aa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a7777a00a77aa000000aa0000aaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aa7777a0aa7777a000aa77a00a7777a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a77777a0aa7777a00a77777a0a7777a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aa7777a00a7777a00a77777a0a7777aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aa77a000a7777a00a7777a00a77777a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000aa00000aaaa000a7777a000aaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000aaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00009999999200000000d6777777000000004aaaaaaa00000056d000000000000000000000000000000000000000000000000000000000000000000000000000
0009999999424000000d5d6777777000000949aaaaaaa00005d66500000000000000000000000000000000000000000000000000000000000b00000000000000
000999999942400000ddddd677777700000949aaaaaaa0000d666600000000000000000000000000000000000000000000000000000000000bb0000000000000
00999999944244000ddd5ddd677777700099499aaaaaaa005ddd66d00000000000000000000000000000000000000000000000000000000000b00bb000000000
0099999994424400ddddddddd66666600099499aaaaaaa0055ddddd00000000000000000000000000000000000000000000000000000000000b0bb00000000b0
0999999944424440dddd5dddd666666009994999aaaaaaa0555ddd5000000000000000000000000000000000000000000000000000000000000000000bb00bb0
0999999944424040ddddddddd666666009994999aaaaaaa005555500000000000000000000000000000000000000000000000000000000000000000000bb0b00
9099099444420044dddd50ddd6060660999949099aaaa0aa00000000000000000000000000000000000000000000000000000000000000000000000000000000
000088888881000000005ccccccc00000000d7777777000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc
0008888888212000000d5dccccccc0000006d6777777700000000000000000000000000000000000000000000000000000000000000000000000cccccccccccc
0008888888212000000d5dccccccc0000006d677777770000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc
008888888221220000dd5ddccccccc000066d66777777700000000000000000000000000000000000000000000000000000000000000000000cccccccccccccc
008888888221220000dd5ddccccccc000066d6677777770000000000000000000000000000000000000000000000000000000000000000000ccccccccccccccc
08888888222122200ddd5dddccccccc00666d6667777777000000000000000000000000000000000000000000000000000000000000000000ccccccccccccccc
08888888222122200ddd5dddccc0ccc00666d666777777700000000000000000000000000000000000000000000000000000000000000000cccccccccccccccc
8080888220212222dd0d5ddddc00cccc6666d606677770770000000000000000000000000000000000000000000000000000000000000000cccccccccccccccc
00000000005000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000666666666600000000000b0000000000550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0669eeeeeeee966000550000bb00bb00005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66eeeeeeeeeeee66550050000b0bb000005000500000000055000000000000000000000000000000000000000000000000000000000000000000000000000000
66eeeeeeeeeeee6600005000005b0500000555000055550000550050000000000000000000000000000000000000000000000000000000000000000000000000
d669eeeeeeee966d0000055005000055000000000000005000005500000000000000000000000000000000000000000000000000000000000000000000000000
0dd66666666660d00000000005000000000000000000550000000000000000000000000000000000000000000000000000000000000000000000000000000000
000d0d5ddd0dd0000000000050000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010101010101000000000000000000010101010101000000000000000001010000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
000000000000000052534f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4f000042430000404100000000004e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000404100000042430000005253000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5100000000000000525300444500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000005051525340410000004041000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00004e0000005051000000000050514000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0046000000424300004f00000000004f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000052530000650000525342435000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000006360616200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00404100000000644f0000000040410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5455000000004041000000004243000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000050515253444500004600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000005253000000000000000000505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
004e50510000004041505100004f4e5e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4f0000545500000000004041005e5f5f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00004f0000000000004445465e5f5f5f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00010000095500d5501155018530235302a52033520395100110001100210001e0001c0001a00015000110000e0000d0000b0000b000000000000000000000000000000000000000000000000000000000000000
0002000003030060500b050150501c050235000e0501105014050180501e050290500000015050170501b0501f05023050290503005000000000001a0501e050210502405026050290502e050320503805000000
000100002205000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
